name: Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
      - "release/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  # contents: write - Store coverage data in the repository (in a data branch)
  # pull-requests: write - Post coverage comments on PRs

jobs:
  py-ruff:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
        with:
          python-version: ${{ matrix.python-version }}
      - name: Lint with Ruff
        run: uv run ruff check .
      - name: Format with Ruff
        run: uv run ruff format --check .
      - name: Check public API docstrings
        run: uv run python scripts/check_public_docstrings.py

  py-type:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
        with:
          python-version: ${{ matrix.python-version }}
      - name: Type check with pyright
        run: uv run pyright

  py-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup
        with:
          python-version: ${{ matrix.python-version }}
      - name: Run tests with coverage
        run: uv run pytest --cov --cov-report=term --cov-report=xml
      - name: Coverage comment
        if: matrix.python-version == '3.10'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 95
          MINIMUM_ORANGE: 90
      - name: Ensure no files modified during tests
        run: |
          if [[ $(git status --porcelain) != "" ]]
          then
            echo "Checked in files modified by tests. If expected, please run locally and check in the changes."
            git status
            git diff
            exit 1
          fi

  py-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install uv
        uses: astral-sh/setup-uv@v3
      - name: Install build dependencies
        run: uv pip install --system build
      - name: Build package
        run: python -m build
      - name: Verify package
        run: |
          uv pip install --system dist/*.whl
          python -c "import inspect_flow; print('Package imported successfully')"

  check-type-gen:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
        with:
          python-version: ${{ matrix.python-version }}
      - name: Generate types
        run: uv run python src/inspect_flow/_types/type_gen.py
      - name: Ensure schema and types changes are checked in
        run: |
          if [[ $(git status --porcelain) != "" ]]
          then
            echo "Generated types are out of date. Please run python src/inspect_flow/_types/type_gen.py and check in the changes."
            git status
            git diff
            exit 1
          fi
